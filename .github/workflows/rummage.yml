name: Daily Palia Rummage Post

on:
  schedule:
    - cron: "0 5 * * *"   # 12:00am EST = 05:00 UTC
  workflow_dispatch:

jobs:
  post:
    runs-on: ubuntu-latest
    steps:
      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install requests pillow playwright
          python -m playwright install --with-deps chromium

      - name: Render maps + extract grid + post to Discord
        env:
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          python - <<'EOF'
          import os, io, json, re
          import requests
          from datetime import datetime
          from PIL import Image
          from playwright.sync_api import sync_playwright

          webhook = os.environ.get("WEBHOOK")
          if not webhook:
              raise SystemExit("Missing DISCORD_WEBHOOK_URL secret.")

          MAPS = [
              ("üåø Kilima Valley", "https://palia.th.gl/rummage-pile?map=kilima-valley"),
              ("üåä Bahari Bay", "https://palia.th.gl/rummage-pile?map=bahari-bay"),
              ("üå≤ Elderwood", "https://palia.th.gl/rummage-pile?map=elderwood"),
          ]

          GRID_RE = re.compile(r"\b([A-Z])\s?([1-9]|1[0-9]|20)\b")  # A1..Z20 (covers C6)

          def extract_grid_from_text(text: str):
              m = GRID_RE.search(text or "")
              return f"{m.group(1)}{m.group(2)}" if m else None

          # Try to click a rummage marker and read any popup/tooltip text
          def detect_grid_from_ui(page):
              # Candidate selectors for map tooltips/popups (covers common map libs)
              popup_selectors = [
                  '[role="tooltip"]',
                  '.maplibregl-popup-content',
                  '.mapboxgl-popup-content',
                  '.leaflet-popup-content',
                  '.tippy-content',
                  '[data-state="open"]',
              ]

              # Candidate selectors to click rummage markers/icons
              click_targets = [
                  '[aria-label*="Rummage" i]',
                  '[title*="Rummage" i]',
                  'text=/Rummage/i',
                  '[aria-label*="Pile" i]',
                  '[title*="Pile" i]',
              ]

              # 1) Try clicking something that looks like the rummage marker/button
              for sel in click_targets:
                  try:
                      loc = page.locator(sel).first
                      if loc.count() > 0:
                          loc.click(timeout=1500)
                          page.wait_for_timeout(800)
                          break
                  except Exception:
                      pass

              # 2) Read popup/tooltip content if it exists
              for psel in popup_selectors:
                  try:
                      ploc = page.locator(psel).first
                      if ploc.count() > 0:
                          txt = ploc.inner_text(timeout=1500)
                          g = extract_grid_from_text(txt)
                          if g:
                              return g, txt.strip()
                  except Exception:
                      pass

              # 3) Fallback: scan a small set of likely UI containers for grid codes
              # (avoid scanning full body because the loot table can be huge)
              containers = [
                  "main",
                  "header",
                  "aside",
                  ".container",
                  '[class*="map" i]',
              ]
              for csel in containers:
                  try:
                      cloc = page.locator(csel).first
                      if cloc.count() > 0:
                          txt = cloc.inner_text(timeout=1500)
                          g = extract_grid_from_text(txt)
                          if g:
                              return g, None
                  except Exception:
                      pass

              return None, None

          screenshots = []
          map_results = {}  # name -> (grid, extra_text)

          with sync_playwright() as p:
              browser = p.chromium.launch()
              context = browser.new_context(viewport={"width": 1280, "height": 720})
              page = context.new_page()

              for name, url in MAPS:
                  page.goto(url, wait_until="networkidle", timeout=60000)
                  page.wait_for_timeout(3500)  # let markers settle

                  grid, extra = detect_grid_from_ui(page)
                  map_results[name] = (grid, extra)

                  # Screenshot (cropping top nav a bit)
                  png_bytes = page.screenshot(full_page=False)
                  img = Image.open(io.BytesIO(png_bytes)).convert("RGB")
                  w, h = img.size
                  crop_top = 110
                  img = img.crop((0, crop_top, w, h))
                  screenshots.append(img)

              browser.close()

          # Build vertical collage image
          collage_w = max(im.size[0] for im in screenshots)
          collage_h = sum(im.size[1] for im in screenshots)
          collage = Image.new("RGB", (collage_w, collage_h), (255, 255, 255))
          y = 0
          for im in screenshots:
              collage.paste(im, (0, y))
              y += im.size[1]

          out = io.BytesIO()
          collage.save(out, format="PNG", optimize=True)
          out.seek(0)

          # Build embed fields with grid callouts + links
          fields = []
          for (name, url) in MAPS:
              grid, extra = map_results.get(name, (None, None))
              if grid:
                  value = f"**Loot pile:** `{grid}`\n[Open map]({url})"
              else:
                  value = f"**Loot pile:** `(not detected yet)`\n[Open map]({url})"
              fields.append({"name": name, "value": value, "inline": False})

          embed = {
              "title": "üóìÔ∏è Today's Rummage Piles",
              "description": "Map + grid callouts (3 maps).",
              "fields": fields,
              "image": {"url": "attachment://rummage.png"},
              "footer": {"text": "Source: palia.th.gl"},
              "timestamp": datetime.utcnow().isoformat()
          }

          payload_json = {"username": "Palia Rummage Tracker", "embeds": [embed]}
          files = {
              "payload_json": (None, json.dumps(payload_json), "application/json"),
              "files[0]": ("rummage.png", out, "image/png"),
          }

          resp = requests.post(webhook, files=files, timeout=60)
          print("Discord status:", resp.status_code)
          print(resp.text[:500])
          resp.raise_for_status()
          EOF
