name: Daily Palia Rummage Post

on:
  schedule:
    - cron: "0 5 * * *"   # 12:00am EST (winter) = 05:00 UTC
  workflow_dispatch:

jobs:
  post:
    runs-on: ubuntu-latest
    steps:
      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install requests pillow playwright
          python -m playwright install --with-deps chromium

      - name: Render cropped maps + post to Discord
        env:
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          python - <<'EOF'
          import os, io, json
          import requests
          from datetime import datetime
          from PIL import Image, ImageDraw
          from playwright.sync_api import sync_playwright

          webhook = os.environ.get("WEBHOOK")
          if not webhook:
              raise SystemExit("Missing DISCORD_WEBHOOK_URL secret.")

          maps = [
              ("ðŸŒ¿ Kilima Valley", "https://palia.th.gl/rummage-pile?map=kilima-valley"),
              ("ðŸŒŠ Bahari Bay", "https://palia.th.gl/rummage-pile?map=bahari-bay"),
              ("ðŸŒ² Elderwood", "https://palia.th.gl/rummage-pile?map=elderwood"),
          ]

          screenshots = []

          with sync_playwright() as p:
              browser = p.chromium.launch()
              # Discord-friendly viewport
              context = browser.new_context(viewport={"width": 1100, "height": 600})
              page = context.new_page()

              for name, url in maps:
                  page.goto(url, wait_until="networkidle", timeout=60000)
                  page.wait_for_timeout(2500)

                  png_bytes = page.screenshot(full_page=False)
                  img = Image.open(io.BytesIO(png_bytes)).convert("RGB")

                  # --- CROPPING (fine-tuned from your feedback) ---
                  w, h = img.size

                  crop_top = int(0.22 * h)      # â¬†ï¸ more cropped from top
                  crop_bottom = int(0.985 * h)  # â¬‡ï¸ less cropped from bottom
                  crop_left = int(0.14 * w)     # perfect as-is
                  crop_right = int(0.86 * w)    # perfect as-is

                  img = img.crop((crop_left, crop_top, crop_right, crop_bottom))

                  # --- Optional polish: subtle border ---
                  draw = ImageDraw.Draw(img)
                  draw.rectangle(
                      [0, 0, img.size[0]-1, img.size[1]-1],
                      outline=(200, 200, 200)
                  )

                  screenshots.append(img)

              browser.close()

          # Build vertical collage
          collage_w = max(im.size[0] for im in screenshots)
          collage_h = sum(im.size[1] for im in screenshots)

          collage = Image.new("RGB", (collage_w, collage_h), (255, 255, 255))
          y = 0
          for im in screenshots:
              collage.paste(im, (0, y))
              y += im.size[1]

          out = io.BytesIO()
          collage.save(out, format="PNG", optimize=True)
          out.seek(0)

          # Embed fields
          fields = []
          for name, url in maps:
              fields.append({
                  "name": name,
                  "value": f"[Open todayâ€™s rummage map]({url})",
                  "inline": False
              })

          embed = {
              "title": "ðŸ—“ï¸ Today's Rummage Piles",
              "description": "Daily map screenshots (3 maps).",
              "fields": fields,
              "image": {"url": "attachment://rummage.png"},
              "footer": {"text": "Source: palia.th.gl"},
              "timestamp": datetime.utcnow().isoformat()
          }

          payload_json = {
              "username": "Palia Rummage Tracker",
              "embeds": [embed]
          }

          files = {
              "payload_json": (None, json.dumps(payload_json), "application/json"),
              "files[0]": ("rummage.png", out, "image/png"),
          }

          resp = requests.post(webhook, files=files, timeout=60)
          print("Discord status:", resp.status_code)
          print(resp.text[:500])
          resp.raise_for_status()
          EOF
