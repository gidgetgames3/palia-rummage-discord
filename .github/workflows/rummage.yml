import os
import requests
from bs4 import BeautifulSoup
from datetime import datetime

WEBHOOK = os.environ["WEBHOOK"]  # ‚úÖ pulls from GitHub Actions env var

maps = {
    "Kilima Valley": "https://palia.th.gl/rummage-pile?map=kilima-valley",
    "Bahari Bay": "https://palia.th.gl/rummage-pile?map=bahari-bay",
    "Elderwood": "https://palia.th.gl/rummage-pile?map=elderwood"
}

fields = []

for name, url in maps.items():
    r = requests.get(url, timeout=20)
    soup = BeautifulSoup(r.text, "html.parser")

    text = soup.get_text(" ", strip=True)
    snippet = text[:300] + "..."

    fields.append({
        "name": name,
        "value": snippet
    })

embed = {
    "title": "üóìÔ∏è Today's Rummage Piles",
    "description": "Daily locations from palia.th.gl",
    "fields": fields,
    "footer": {"text": "Source: palia.th.gl"},
    "timestamp": datetime.utcnow().isoformat()
}

payload = {"username": "Palia Rummage Tracker", "embeds": [embed]}

resp = requests.post(WEBHOOK, json=payload)
print("Discord status:", resp.status_code)
print(resp.text[:500])
resp.raise_for_status()  # ‚úÖ makes failures obvious in logs
