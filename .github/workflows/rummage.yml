name: Daily Palia Rummage Post

on:
  schedule:
    - cron: "0 13 * * *"
  workflow_dispatch:

jobs:
  post:
    runs-on: ubuntu-latest
    steps:
      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install requests pillow playwright
          python -m playwright install --with-deps chromium

      - name: Render maps + post screenshot collage to Discord
        env:
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          python - <<'EOF'
          import os, io, json
          import requests
          from datetime import datetime
          from PIL import Image

          from playwright.sync_api import sync_playwright

          webhook = os.environ.get("WEBHOOK")
          if not webhook:
              raise SystemExit("Missing DISCORD_WEBHOOK_URL secret.")

          maps = [
              ("ðŸŒ¿ Kilima Valley", "https://palia.th.gl/rummage-pile?map=kilima-valley"),
              ("ðŸŒŠ Bahari Bay", "https://palia.th.gl/rummage-pile?map=bahari-bay"),
              ("ðŸŒ² Elderwood", "https://palia.th.gl/rummage-pile?map=elderwood"),
          ]

          screenshots = []

          with sync_playwright() as p:
              browser = p.chromium.launch()
              context = browser.new_context(viewport={"width": 1280, "height": 720})
              page = context.new_page()

              for name, url in maps:
                  page.goto(url, wait_until="networkidle", timeout=60000)
                  page.wait_for_timeout(3000)  # let tiles/markers settle

                  png_bytes = page.screenshot(full_page=False)
                  img = Image.open(io.BytesIO(png_bytes)).convert("RGB")

                  # Crop off a bit of the top nav to focus on the map area
                  w, h = img.size
                  crop_top = 110
                  img = img.crop((0, crop_top, w, h))

                  screenshots.append(img)

              browser.close()

          # Make a vertical collage
          widths = [im.size[0] for im in screenshots]
          heights = [im.size[1] for im in screenshots]
          collage_w = max(widths)
          collage_h = sum(heights)

          collage = Image.new("RGB", (collage_w, collage_h), (255, 255, 255))
          y = 0
          for im in screenshots:
              collage.paste(im, (0, y))
              y += im.size[1]

          out = io.BytesIO()
          collage.save(out, format="PNG", optimize=True)
          out.seek(0)

          # Build embed
          fields = []
          for name, url in maps:
              fields.append({"name": name, "value": f"[Open map]({url})", "inline": False})

          embed = {
              "title": "ðŸ—“ï¸ Today's Rummage Piles",
              "description": "Rendered daily from palia.th.gl (3 maps).",
              "fields": fields,
              "image": {"url": "attachment://rummage.png"},
              "footer": {"text": "Source: palia.th.gl"},
              "timestamp": datetime.utcnow().isoformat()
          }

          payload_json = {"username": "Palia Rummage Tracker", "embeds": [embed]}

          # Webhook file upload uses multipart/form-data with payload_json + file
          files = {
              "payload_json": (None, json.dumps(payload_json), "application/json"),
              "files[0]": ("rummage.png", out, "image/png"),
          }

          resp = requests.post(webhook, files=files, timeout=60)
          print("Discord status:", resp.status_code)
          print(resp.text[:500])
          resp.raise_for_status()
          EOF
