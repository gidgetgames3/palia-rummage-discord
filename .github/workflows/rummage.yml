name: Daily Palia Rummage Post

on:
  schedule:
    - cron: "0 13 * * *"
  workflow_dispatch:

jobs:
  post:
    runs-on: ubuntu-latest
    steps:
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4

      - name: Fetch rummage data and post to Discord
        env:
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          python - <<'EOF'
          import os
          import requests
          from bs4 import BeautifulSoup
          from datetime import datetime

          webhook = os.environ.get("WEBHOOK")
          if not webhook:
            raise SystemExit("Missing DISCORD_WEBHOOK_URL secret (WEBHOOK env var is empty).")

          maps = {
              "üåø Kilima Valley": "https://palia.th.gl/rummage-pile?map=kilima-valley",
              "üåä Bahari Bay": "https://palia.th.gl/rummage-pile?map=bahari-bay",
              "üå≤ Elderwood": "https://palia.th.gl/rummage-pile?map=elderwood",
          }

          fields = []
          for name, url in maps.items():
              r = requests.get(url, timeout=25)
              r.raise_for_status()
              soup = BeautifulSoup(r.text, "html.parser")
              text = soup.get_text(" ", strip=True)

              # temporary fallback so you at least see *something* post
              snippet = (text[:250] + "...") if len(text) > 250 else text

              fields.append({"name": name, "value": snippet, "inline": False})

          embed = {
              "title": "üóìÔ∏è Today's Rummage Piles",
              "description": "Daily locations from palia.th.gl (3 maps).",
              "fields": fields,
              "footer": {"text": "Source: palia.th.gl"},
              "timestamp": datetime.utcnow().isoformat()
          }

          payload = {"username": "Palia Rummage Tracker", "embeds": [embed]}
          resp = requests.post(webhook, json=payload)
          print("Discord status:", resp.status_code)
          print(resp.text[:500])
          resp.raise_for_status()
          EOF
