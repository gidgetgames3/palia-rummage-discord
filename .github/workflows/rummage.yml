name: Daily Palia Rummage Post

on:
  schedule:
    - cron: "0 13 * * *"
  workflow_dispatch:

jobs:
  post:
    runs-on: ubuntu-latest
    steps:
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Debug TH.GL pages and post to Discord
        env:
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          python - <<'EOF'
          import os
          import requests
          from datetime import datetime

          webhook = os.environ.get("WEBHOOK")
          if not webhook:
              raise SystemExit("Missing DISCORD_WEBHOOK_URL secret (WEBHOOK env var is empty).")

          HEADERS = {"User-Agent": "Mozilla/5.0 (compatible; PaliaRummageBot/1.0)"}

          maps = {
              "ðŸŒ¿ Kilima Valley": "https://palia.th.gl/rummage-pile?map=kilima-valley",
              "ðŸŒŠ Bahari Bay": "https://palia.th.gl/rummage-pile?map=bahari-bay",
              "ðŸŒ² Elderwood": "https://palia.th.gl/rummage-pile?map=elderwood",
          }

          fields = []
          for name, url in maps.items():
              r = requests.get(url, headers=HEADERS, timeout=25)
              r.raise_for_status()

              has_next = "__NEXT_DATA__" in r.text

              fields.append({
                  "name": name,
                  "value": f"__NEXT_DATA__ present: `{has_next}`\n[Open todayâ€™s rummage map]({url})",
                  "inline": False
              })

          embed = {
              "title": "ðŸ—“ï¸ Today's Rummage Piles (Debug)",
              "description": "Checking whether TH.GL exposes embedded data we can parse.",
              "fields": fields,
              "footer": {"text": "Temporary debug run"},
              "timestamp": datetime.utcnow().isoformat()
          }

          payload = {"username": "Palia Rummage Tracker", "embeds": [embed]}
          resp = requests.post(webhook, json=payload)
          print("Discord status:", resp.status_code)
          print(resp.text[:500])
          resp.raise_for_status()
          EOF
